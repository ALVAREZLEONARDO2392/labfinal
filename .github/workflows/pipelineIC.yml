name: workflow

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
      
jobs:
        SAST:
          runs-on: ubuntu-24.04
      
          steps:
            
            - name: Checkout Code
              uses: actions/checkout@v3
      
           
            - name: Set up Node.js
              uses: actions/setup-node@v3
              with:
                node-version: '16' 
      
           
            - name: Install Dependencies
              run: |
                npm install 
                if [ -d "./functions" ]; then
                 cd ./functions
                  npm install 
                cd ..
                fi
      
            
            - name: Configure SonarCloud Scanner
              run: |
                echo "sonar.projectKey=ALVAREZLEONARDO2392_labfinal" >> sonar-project.properties
                echo "sonar.organization=alvarezleonardo2392" >> sonar-project.properties
                echo "sonar.host.url=https://sonarcloud.io" >> sonar-project.properties
                echo "sonar.login=${{ secrets.SONAR_TOKEN }}" >> sonar-project.properties
                echo "sonar.sources=." >> sonar-project.properties
                echo "sonar.exclusions=**/node_modules/**" >> sonar-project.properties
                echo "sonar.javascript.packageManager=npm" >> sonar-project.properties

            - name: Run SonarCloud Scanner
              run: npx sonar-scanner
        
        Dependency-Check:

          runs-on: ubuntu-latest
          needs: SAST

          steps:

            - name: Run OWASP Dependency-Check
              uses: dependency-check/Dependency-Check_Action@main
              with:
                project: 'labfinal'
                path: '.'
                format: 'HTML'
                out: 'dependency-check-report'
                args: '--failOnCVSS 20'
           ###### art     
            - name: Upload Dependency-Check Report
              uses: actions/upload-artifact@v3
              with:
                  name: dependency-check-report
                  path: dependency-check-report/dependency-check-report.html

    
        push_to_registry:
          name: Push Docker image to Docker Hub
          runs-on: ubuntu-latest
          permissions:
            packages: write
            contents: read
            attestations: write
            id-token: write
          steps:
            - name: Check out the repo
              uses: actions/checkout@v4

            - name: Log in to Docker Hub
              uses: docker/login-action@f4ef78c080cd8ba55a85445d5b36e214a81df20a
              with:
                username: ${{ secrets.DOCKERHUB_USERNAME }}
                password: ${{ secrets.DOCKERHUB_PASSWORD }}

            - name: Build Docker image
              id: build
              uses: docker/build-push-action@3b5e8027fcad23fda98b2e3ac259d8d67585f671
              with:
                  context: .
                  file: ./Dockerfile
                  push: true
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
            
            - name: Log in to Docker Hub
              uses: docker/login-action@v2.1.0
              with:
                    username: ${{ secrets.DOCKERHUB_USERNAME }}
                    password: ${{ secrets.DOCKERHUB_TOKEN }}
          
            - name: Build and Push Docker Image
              uses: docker/build-push-action@v4
              with:
                    context: .
                    tags: rene0311/my-docker-hub-repository:latest
                    push: true
          
            - name: Docker Scout Quickview and CVEs
              uses: docker/scout-action@v1
              with:
                    command: quickview,cves
                    image: rene0311/my-docker-hub-repository:latest
          
            - name: Docker Scout SBOM
              uses: docker/scout-action@v1
              with:
                    command: sbom
                    image: rene0311/my-docker-hub-repository:latest
                    output: sbom.json
          
            - name: Docker Scout Recommendations
              uses: docker/scout-action@v1
              with:
                    command: recommendations
                    image: rene0311/my-docker-hub-repository:latest
          
            - name: Upload Docker Scout SARIF Report
              uses: github/codeql-action/upload-sarif@v2
              with:
                    sarif_file: scout.sarif
            # - name: Generate artifact attestation
            #   uses: actions/attest-build-provenance@v2
            #   with:
            #     subject-name: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME}}
            #     subject-digest: ${{ steps.push.outputs.digest }}
            #     push-to-registry: true






















        # Image:
          
        #   runs-on: ubuntu-latest
        #   needs: Dependency-Check
          
        #   steps:
        #     - name: List Files in Root
        #       run: ls -la
         
              
        #     - name: Change Directory to Current Directory `.`
        #       run: cd .
            
        #     - name: Build Docker Image
        #       run: |
        #         docker build -t labfinal1 -f ./Dockerfile .
  
        #     - name: Run Trivy Scan
        #       uses: aquasecurity/trivy-action@0.28.0
        #       with:
        #         image-ref: 'node:lts-alpine3.21'
        #         format: 'table'
        #         severity: 'HIGH,CRITICAL'
        #         ignore-unfixed: true
