name: workflow

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
      
jobs:
        SAST:
          runs-on: ubuntu-24.04
      
          steps:
            
            - name: Checkout Code
              uses: actions/checkout@v3
      
           
            - name: Set up Node.js
              uses: actions/setup-node@v3
              with:
                node-version: '16' 
      
           
            - name: Install Dependencies
              run: |
                npm install 
                if [ -d "./functions" ]; then
                 cd ./functions
                  npm install 
                cd ..
                fi
      
            
            - name: Configure SonarCloud Scanner
              run: |
                echo "sonar.projectKey=ALVAREZLEONARDO2392_labfinal" >> sonar-project.properties
                echo "sonar.organization=alvarezleonardo2392" >> sonar-project.properties
                echo "sonar.host.url=https://sonarcloud.io" >> sonar-project.properties
                echo "sonar.login=${{ secrets.SONAR_TOKEN }}" >> sonar-project.properties
                echo "sonar.sources=." >> sonar-project.properties
                echo "sonar.exclusions=**/node_modules/**" >> sonar-project.properties
                echo "sonar.javascript.packageManager=npm" >> sonar-project.properties

            - name: Run SonarCloud Scanner
              run: npx sonar-scanner
        
        Dependency-Check:

          runs-on: ubuntu-latest
          needs: SAST

          steps:

            - name: Run OWASP Dependency-Check
              uses: dependency-check/Dependency-Check_Action@main
              with:
                project: 'labfinal'
                path: '.'
                format: 'HTML'
                out: 'dependency-check-report'
                args: '--failOnCVSS 20'
           ###### art     
            - name: Upload Dependency-Check Report
              uses: actions/upload-artifact@v3
              with:
                  name: dependency-check-report
                  path: dependency-check-report/dependency-check-report.html

        build:
          name: push docker image to docker hub
          runs-on: ubuntu-latest
          steps:
                - uses: actions/checkout@v2
                - name: login to docker hub
                  id: docker-hub
                  env:
                    username: ${{secrets.DOCKERHUB_USERNAME}}
                    password: ${{secrets.DOCKERHUB_PASSWORD}}
                  run: |
                    docker login -u $username -p $password 
                - name: build the docker image
                  id: build-docker-image
                  run: |
                    ls -la 
                    docker build . -f Dockerfile -t cf86b7326896
                - name: push the docker image
                  id: push-docker-image
                  run: docker push ${{secrets.DOCKERHUB_USERNAME}}/cf86b7326896






















        # Image:
          
        #   runs-on: ubuntu-latest
        #   needs: Dependency-Check
          
        #   steps:
        #     - name: List Files in Root
        #       run: ls -la
         
              
        #     - name: Change Directory to Current Directory `.`
        #       run: cd .
            
        #     - name: Build Docker Image
        #       run: |
        #         docker build -t labfinal1 -f ./Dockerfile .
  
        #     - name: Run Trivy Scan
        #       uses: aquasecurity/trivy-action@0.28.0
        #       with:
        #         image-ref: 'node:lts-alpine3.21'
        #         format: 'table'
        #         severity: 'HIGH,CRITICAL'
        #         ignore-unfixed: true
